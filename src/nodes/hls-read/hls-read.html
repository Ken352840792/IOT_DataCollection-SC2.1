<!-- HLS-Read节点配置界面 -->

<!-- Embedded shared styles and components -->
<style>
/**
 * Shared CSS styles for HLS communication nodes
 * Node-RED UI styling conventions
 */

/* Node-RED form styling enhancements */
.hls-form-section {
  margin-bottom: 20px;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 15px;
  background-color: #f9f9f9;
}

.hls-form-section-header {
  font-weight: bold;
  color: #333;
  margin-bottom: 10px;
  font-size: 14px;
  border-bottom: 1px solid #ddd;
  padding-bottom: 5px;
}

.hls-form-section.collapsed .hls-form-section-content {
  display: none;
}

.hls-form-section-toggle {
  cursor: pointer;
  user-select: none;
  float: right;
  color: #666;
}

.hls-form-section-toggle:hover {
  color: #333;
}

/* Enhanced form controls */
.hls-form-row {
  margin-bottom: 15px;
  display: flex;
  align-items: center;
}

.hls-form-label {
  width: 120px;
  margin-right: 10px;
  font-weight: normal;
  color: #333;
  text-align: right;
}

.hls-form-control {
  flex: 1;
  min-width: 200px;
}

.hls-form-control input,
.hls-form-control select {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #ccc;
  border-radius: 3px;
  font-size: 13px;
}

.hls-form-control input:focus,
.hls-form-control select:focus {
  outline: none;
  border-color: #3FADB5;
  box-shadow: 0 0 5px rgba(63, 173, 181, 0.3);
}

/* Validation states */
.hls-form-control.has-error input,
.hls-form-control.has-error select {
  border-color: #d9534f;
  box-shadow: 0 0 5px rgba(217, 83, 79, 0.3);
}

.hls-form-control.has-success input,
.hls-form-control.has-success select {
  border-color: #5cb85c;
  box-shadow: 0 0 5px rgba(92, 184, 92, 0.3);
}

.hls-form-control.has-warning input,
.hls-form-control.has-warning select {
  border-color: #f0ad4e;
  box-shadow: 0 0 5px rgba(240, 173, 78, 0.3);
}

/* Error messages */
.hls-error-message {
  color: #d9534f;
  font-size: 11px;
  margin-top: 4px;
  display: block;
}

.hls-success-message {
  color: #5cb85c;
  font-size: 11px;
  margin-top: 4px;
  display: block;
}

.hls-warning-message {
  color: #f0ad4e;
  font-size: 11px;
  margin-top: 4px;
  display: block;
}

/* Buttons */
.hls-btn {
  padding: 6px 12px;
  font-size: 12px;
  border-radius: 3px;
  border: 1px solid transparent;
  cursor: pointer;
  display: inline-block;
  margin-right: 5px;
  text-decoration: none;
}

.hls-btn-primary {
  background-color: #3FADB5;
  border-color: #3FADB5;
  color: white;
}

.hls-btn-primary:hover {
  background-color: #359ca3;
  border-color: #359ca3;
}

.hls-btn-secondary {
  background-color: #6c757d;
  border-color: #6c757d;
  color: white;
}

.hls-btn-secondary:hover {
  background-color: #5a6268;
  border-color: #5a6268;
}

.hls-btn-success {
  background-color: #28a745;
  border-color: #28a745;
  color: white;
}

.hls-btn-danger {
  background-color: #dc3545;
  border-color: #dc3545;
  color: white;
}

.hls-btn-warning {
  background-color: #ffc107;
  border-color: #ffc107;
  color: #212529;
}

.hls-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Data points table */
.hls-data-points-container {
  border: 1px solid #ddd;
  border-radius: 4px;
  min-height: 150px;
  max-height: 400px;
  overflow-y: auto;
}

.hls-data-points-header {
  background-color: #f5f5f5;
  border-bottom: 1px solid #ddd;
  padding: 8px;
  font-weight: bold;
  display: grid;
  grid-template-columns: 2fr 2fr 1.5fr 2fr auto;
  gap: 10px;
  align-items: center;
}

.hls-data-point-row {
  padding: 8px;
  border-bottom: 1px solid #eee;
  display: grid;
  grid-template-columns: 2fr 2fr 1.5fr 2fr auto;
  gap: 10px;
  align-items: center;
}

.hls-data-point-row:hover {
  background-color: #f9f9f9;
}

.hls-data-point-row:last-child {
  border-bottom: none;
}

.hls-data-point-input {
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 2px;
  font-size: 12px;
  width: 100%;
}

.hls-data-point-select {
  padding: 4px 6px;
  border: 1px solid #ccc;
  border-radius: 2px;
  font-size: 12px;
  width: 100%;
  background-color: white;
}

.hls-data-point-actions {
  display: flex;
  gap: 5px;
}

.hls-data-point-actions button {
  padding: 2px 6px;
  font-size: 10px;
  border-radius: 2px;
  border: none;
  cursor: pointer;
}

.hls-remove-point {
  background-color: #dc3545;
  color: white;
}

.hls-remove-point:hover {
  background-color: #c82333;
}

/* Connection test status */
.hls-connection-status {
  padding: 8px 12px;
  border-radius: 4px;
  margin-top: 10px;
  font-size: 12px;
  font-weight: bold;
}

.hls-connection-status.testing {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

.hls-connection-status.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.hls-connection-status.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

/* Templates dropdown */
.hls-template-selector {
  margin-bottom: 15px;
  padding: 10px;
  background-color: #e8f4f8;
  border-radius: 4px;
  border: 1px solid #3FADB5;
}

.hls-template-selector label {
  font-weight: bold;
  margin-right: 10px;
  color: #333;
}

.hls-template-selector select {
  padding: 4px 8px;
  border: 1px solid #ccc;
  border-radius: 3px;
  margin-right: 10px;
}

/* Import/Export section */
.hls-import-export {
  background-color: #f8f9fa;
  padding: 15px;
  border-radius: 4px;
  border: 1px solid #dee2e6;
  margin-top: 15px;
}

.hls-import-export h4 {
  margin-top: 0;
  margin-bottom: 10px;
  color: #333;
}

.hls-file-input {
  margin-right: 10px;
}

/* Loading overlay */
.hls-loading-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(255, 255, 255, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.hls-loading-spinner {
  width: 30px;
  height: 30px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #3FADB5;
  border-radius: 50%;
  animation: hls-spin 1s linear infinite;
}

@keyframes hls-spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Connection test status */
.hls-connection-status {
  padding: 8px 12px;
  border-radius: 4px;
  margin-top: 10px;
  font-size: 12px;
  font-weight: bold;
}

.hls-connection-status.testing {
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

.hls-connection-status.success {
  background-color: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.hls-connection-status.error {
  background-color: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}
</style>

<script type="text/javascript">
/**
 * Shared JavaScript components for HLS communication nodes
 * Common UI components and utilities
 */

(function(window) {
  'use strict';

  // Global HLS UI namespace
  window.HLS = window.HLS || {};
  window.HLS.UI = window.HLS.UI || {};

  /**
   * Validation utilities
   */
  window.HLS.UI.Validators = {
    
    // IP address validation
    validateIP: function(ip) {
      if (!ip) return { valid: false, message: 'IP地址不能为空' };
      
      const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
      if (!ipRegex.test(ip)) {
        return { valid: false, message: '请输入有效的IP地址格式 (例如: 192.168.1.100)' };
      }
      
      return { valid: true, message: 'IP地址格式正确' };
    },

    // Port number validation
    validatePort: function(port) {
      if (!port) return { valid: false, message: '端口号不能为空' };
      
      const portNum = parseInt(port);
      if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
        return { valid: false, message: '端口号必须在1-65535之间' };
      }
      
      return { valid: true, message: '端口号有效' };
    },

    // Modbus address validation
    validateModbusAddress: function(address) {
      if (!address) return { valid: false, message: '地址不能为空' };
      
      // Support various Modbus address formats
      const addressRegex = /^[0-9]{1,6}$/;
      if (!addressRegex.test(address)) {
        return { valid: false, message: '请输入有效的Modbus地址 (例如: 40001)' };
      }
      
      const addr = parseInt(address);
      if (addr < 1 || addr > 999999) {
        return { valid: false, message: 'Modbus地址范围应在1-999999之间' };
      }
      
      return { valid: true, message: '地址格式正确' };
    },

    // Data type validation
    validateDataType: function(dataType) {
      const validTypes = ['Bool', 'Int16', 'Int32', 'Int64', 'UInt16', 'UInt32', 'UInt64', 'Float', 'Double', 'String'];
      if (!validTypes.includes(dataType)) {
        return { valid: false, message: '不支持的数据类型' };
      }
      return { valid: true, message: '数据类型有效' };
    },

    // Timeout validation
    validateTimeout: function(timeout) {
      if (!timeout) return { valid: false, message: '超时时间不能为空' };
      
      const timeoutNum = parseInt(timeout);
      if (isNaN(timeoutNum) || timeoutNum < 1000 || timeoutNum > 60000) {
        return { valid: false, message: '超时时间应在1000-60000毫秒之间' };
      }
      
      return { valid: true, message: '超时时间有效' };
    }
  };

  /**
   * Form validation helper
   */
  window.HLS.UI.FormValidator = function(formElement) {
    this.form = formElement;
    this.validators = {};
    this.isValid = true;
  };

  window.HLS.UI.FormValidator.prototype = {
    addField: function(fieldName, element, validator, required = true) {
      this.validators[fieldName] = {
        element: element,
        validator: validator,
        required: required
      };
      
      // Add real-time validation
      const self = this;
      $(element).on('blur change', function() {
        self.validateField(fieldName);
      });
      
      return this;
    },

    validateField: function(fieldName) {
      const field = this.validators[fieldName];
      if (!field) return true;

      const value = $(field.element).val();
      const $formGroup = $(field.element).closest('.hls-form-control');
      
      // Clear previous validation state
      $formGroup.removeClass('has-error has-success has-warning');
      $formGroup.find('.hls-error-message, .hls-success-message, .hls-warning-message').remove();

      // Required field check
      if (field.required && !value) {
        this.showFieldError($formGroup, '此字段为必填项');
        return false;
      }

      if (value && field.validator) {
        const result = field.validator(value);
        if (!result.valid) {
          this.showFieldError($formGroup, result.message);
          return false;
        } else {
          this.showFieldSuccess($formGroup, result.message);
          return true;
        }
      }

      return true;
    },

    validateAll: function() {
      let allValid = true;
      for (let fieldName in this.validators) {
        if (!this.validateField(fieldName)) {
          allValid = false;
        }
      }
      this.isValid = allValid;
      return allValid;
    },

    showFieldError: function($formGroup, message) {
      $formGroup.addClass('has-error');
      $formGroup.append('<span class="hls-error-message">' + message + '</span>');
    },

    showFieldSuccess: function($formGroup, message) {
      $formGroup.addClass('has-success');
      if (message) {
        $formGroup.append('<span class="hls-success-message">' + message + '</span>');
      }
    },

    showFieldWarning: function($formGroup, message) {
      $formGroup.addClass('has-warning');
      $formGroup.append('<span class="hls-warning-message">' + message + '</span>');
    }
  };

  /**
   * Data points table component
   */
  window.HLS.UI.DataPointsTable = function(container, options) {
    this.container = $(container);
    this.options = $.extend({
      showDefaultValue: false,
      showReadWrite: false,
      dataTypes: ['Bool', 'Int16', 'Int32', 'Int64', 'UInt16', 'UInt32', 'UInt64', 'Float', 'Double', 'String']
    }, options || {});
    this.dataPoints = [];
    this.init();
  };

  window.HLS.UI.DataPointsTable.prototype = {
    init: function() {
      this.render();
      this.bindEvents();
    },

    render: function() {
      const headers = ['地址', '数据类型', '名称', '描述'];
      if (this.options.showDefaultValue) headers.splice(3, 0, '默认值');
      if (this.options.showReadWrite) headers.splice(-1, 0, '读写');
      headers.push('操作');

      let headerHtml = '<div class="hls-data-points-header">';
      headers.forEach(header => {
        headerHtml += '<div>' + header + '</div>';
      });
      headerHtml += '</div>';

      const html = `
        <div class="hls-data-points-container">
          ${headerHtml}
          <div class="hls-data-points-body"></div>
        </div>
        <div style="margin-top: 10px;">
          <button type="button" class="hls-btn hls-btn-primary hls-add-point">
            <i class="fa fa-plus"></i> 添加数据点
          </button>
          <button type="button" class="hls-btn hls-btn-secondary hls-import-points" style="margin-left: 10px;">
            <i class="fa fa-upload"></i> 批量导入
          </button>
        </div>
      `;

      this.container.html(html);
      this.bodyContainer = this.container.find('.hls-data-points-body');
    },

    bindEvents: function() {
      const self = this;
      
      // Add point button
      this.container.find('.hls-add-point').on('click', function() {
        self.addDataPoint();
      });

      // Import points button
      this.container.find('.hls-import-points').on('click', function() {
        self.showImportDialog();
      });
    },

    addDataPoint: function(data = {}) {
      const point = {
        address: data.address || '',
        dataType: data.dataType || 'Int16',
        name: data.name || '',
        description: data.description || '',
        defaultValue: data.defaultValue || '',
        readWrite: data.readWrite || 'read'
      };

      this.dataPoints.push(point);
      this.renderDataPoint(point, this.dataPoints.length - 1);
    },

    renderDataPoint: function(point, index) {
      const dataTypeOptions = this.options.dataTypes.map(type => 
        `<option value="${type}" ${type === point.dataType ? 'selected' : ''}>${this.getDataTypeLabel(type)}</option>`
      ).join('');

      let cellsHtml = `
        <div>
          <input type="text" class="hls-data-point-input address-input" value="${point.address}" placeholder="40001" />
        </div>
        <div>
          <select class="hls-data-point-select datatype-select">${dataTypeOptions}</select>
        </div>
        <div>
          <input type="text" class="hls-data-point-input name-input" value="${point.name}" placeholder="温度传感器" />
        </div>
      `;

      if (this.options.showDefaultValue) {
        cellsHtml += `
          <div>
            <input type="text" class="hls-data-point-input defaultvalue-input" value="${point.defaultValue}" placeholder="0" />
          </div>
        `;
      }

      if (this.options.showReadWrite) {
        cellsHtml += `
          <div>
            <select class="hls-data-point-select readwrite-select">
              <option value="read" ${point.readWrite === 'read' ? 'selected' : ''}>只读</option>
              <option value="write" ${point.readWrite === 'write' ? 'selected' : ''}>只写</option>
              <option value="readwrite" ${point.readWrite === 'readwrite' ? 'selected' : ''}>读写</option>
            </select>
          </div>
        `;
      }

      cellsHtml += `
        <div>
          <input type="text" class="hls-data-point-input description-input" value="${point.description}" placeholder="数据点描述" />
        </div>
        <div class="hls-data-point-actions">
          <button type="button" class="hls-remove-point" data-index="${index}">删除</button>
        </div>
      `;

      const rowHtml = `<div class="hls-data-point-row" data-index="${index}">${cellsHtml}</div>`;
      this.bodyContainer.append(rowHtml);

      this.bindRowEvents(index);
    },

    bindRowEvents: function(index) {
      const self = this;
      const $row = this.bodyContainer.find(`[data-index="${index}"]`);

      // Remove button
      $row.find('.hls-remove-point').on('click', function() {
        self.removeDataPoint(index);
      });

      // Input change events
      $row.find('input, select').on('change blur', function() {
        self.updateDataPoint(index);
      });

      // Address validation
      $row.find('.address-input').on('blur', function() {
        const address = $(this).val();
        const result = window.HLS.UI.Validators.validateModbusAddress(address);
        const $input = $(this);
        
        $input.removeClass('has-error has-success');
        $input.next('.hls-error-message').remove();
        
        if (!result.valid && address) {
          $input.addClass('has-error');
          $input.after('<div class="hls-error-message">' + result.message + '</div>');
        } else if (result.valid) {
          $input.addClass('has-success');
        }
      });
    },

    updateDataPoint: function(index) {
      const $row = this.bodyContainer.find(`[data-index="${index}"]`);
      const point = this.dataPoints[index];

      point.address = $row.find('.address-input').val();
      point.dataType = $row.find('.datatype-select').val();
      point.name = $row.find('.name-input').val();
      point.description = $row.find('.description-input').val();

      if (this.options.showDefaultValue) {
        point.defaultValue = $row.find('.defaultvalue-input').val();
      }

      if (this.options.showReadWrite) {
        point.readWrite = $row.find('.readwrite-select').val();
      }
    },

    removeDataPoint: function(index) {
      this.dataPoints.splice(index, 1);
      this.refresh();
    },

    refresh: function() {
      this.bodyContainer.empty();
      this.dataPoints.forEach((point, index) => {
        this.renderDataPoint(point, index);
      });
    },

    getDataPoints: function() {
      // Update all data points before returning
      this.dataPoints.forEach((_, index) => {
        this.updateDataPoint(index);
      });
      return this.dataPoints;
    },

    setDataPoints: function(dataPoints) {
      this.dataPoints = dataPoints || [];
      this.refresh();
    },

    getDataTypeLabel: function(type) {
      const labels = {
        'Bool': '布尔',
        'Int16': '16位整数',
        'Int32': '32位整数', 
        'Int64': '64位整数',
        'UInt16': '16位无符号整数',
        'UInt32': '32位无符号整数',
        'UInt64': '64位无符号整数',
        'Float': '单精度浮点数',
        'Double': '双精度浮点数',
        'String': '字符串'
      };
      return labels[type] || type;
    },

    showImportDialog: function() {
      const self = this;
      const dialogHtml = `
        <div class="hls-import-dialog" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
             background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; width: 90%;">
            <h3>批量导入数据点</h3>
            <p>请粘贴JSON格式的数据点配置：</p>
            <textarea id="import-data" rows="10" style="width: 100%; font-family: monospace; font-size: 12px;"></textarea>
            <div style="margin-top: 15px; text-align: right;">
              <button type="button" class="hls-btn hls-btn-secondary cancel-import">取消</button>
              <button type="button" class="hls-btn hls-btn-primary confirm-import" style="margin-left: 10px;">导入</button>
            </div>
          </div>
        </div>
      `;

      $('body').append(dialogHtml);

      $('.cancel-import').on('click', function() {
        $('.hls-import-dialog').remove();
      });

      $('.confirm-import').on('click', function() {
        try {
          const data = JSON.parse($('#import-data').val());
          if (Array.isArray(data)) {
            self.setDataPoints(data);
            $('.hls-import-dialog').remove();
          } else {
            alert('导入数据必须是数组格式');
          }
        } catch (e) {
          alert('JSON格式错误：' + e.message);
        }
      });
    }
  };

  /**
   * Connection test utility
   */
  window.HLS.UI.ConnectionTester = function(options) {
    this.options = options || {};
  };

  window.HLS.UI.ConnectionTester.prototype = {
    test: function(config, callback) {
      const $status = $('.hls-connection-status');
      if ($status.length === 0) {
        const statusHtml = '<div class="hls-connection-status testing">正在测试连接...</div>';
        $('.hls-form-section').first().append(statusHtml);
      } else {
        $status.removeClass('success error').addClass('testing').text('正在测试连接...');
      }

      // Simulate connection test (in real implementation, this would make an API call)
      setTimeout(() => {
        const success = Math.random() > 0.3; // 70% success rate for demo
        const $status = $('.hls-connection-status');
        
        if (success) {
          $status.removeClass('testing error').addClass('success').text('连接测试成功！');
          callback && callback(null, { success: true, message: '连接正常' });
        } else {
          $status.removeClass('testing success').addClass('error').text('连接失败：无法连接到目标设备');
          callback && callback(new Error('连接失败'), null);
        }
      }, 2000);
    }
  };

  /**
   * Configuration templates
   */
  window.HLS.UI.Templates = {
    modbusDefaults: {
      device: {
        protocol: 'ModbusTcp',
        host: '192.168.1.100',
        port: 502,
        timeout: 5000
      },
      dataPoints: [
        { address: '40001', dataType: 'Int16', name: 'AI1', description: '模拟输入1' },
        { address: '40002', dataType: 'Int16', name: 'AI2', description: '模拟输入2' }
      ]
    },

    opcuaDefaults: {
      device: {
        protocol: 'OpcUa',
        host: '192.168.1.100',
        port: 4840,
        timeout: 10000
      },
      dataPoints: [
        { address: 'ns=2;s=Channel1.Device1.Tag1', dataType: 'Int16', name: 'Tag1', description: 'OPC UA标签1' },
        { address: 'ns=2;s=Channel1.Device1.Tag2', dataType: 'Float', name: 'Tag2', description: 'OPC UA标签2' }
      ]
    },

    getTemplate: function(templateName) {
      switch (templateName) {
        case 'modbus-tcp':
          return this.modbusDefaults;
        case 'opc-ua':
          return this.opcuaDefaults;
        default:
          return null;
      }
    }
  };

  /**
   * Import/Export utilities
   */
  window.HLS.UI.ImportExport = {
    exportConfiguration: function(config, filename) {
      const dataStr = JSON.stringify(config, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = filename || 'hls-config.json';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    },

    importConfiguration: function(callback) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const config = JSON.parse(e.target.result);
            callback(null, config);
          } catch (err) {
            callback(new Error('配置文件格式错误：' + err.message));
          }
        };
        reader.readAsText(file);
      };

      input.click();
    }
  };

})(window);

  RED.nodes.registerType('hls-read', {
    category: 'HLS通信',
    color: '#3FADB5',
    defaults: {
      name: { value: '' },
      deviceId: { value: '', required: true },
      addresses: { value: [] },
      interval: { value: 1000, validate: RED.validators.number() },
      server: { value: 'localhost' },
      port: { value: 8888, validate: RED.validators.number() },
      protocol: { value: 'ModbusTcp' },
      devicePort: { value: 502, validate: RED.validators.number() },
      timeout: { value: 5000, validate: RED.validators.number() }
    },
    inputs: 1,
    outputs: 1,
    icon: 'bridge-dash.svg',
    label: function () {
      return this.name || 'HLS读取';
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    },
    oneditprepare: function () {
      const self = this;
      
      // Initialize form validator
      this.validator = new HLS.UI.FormValidator(this);
      this.validator
        .addField('deviceId', '#node-input-deviceId', HLS.UI.Validators.validateIP)
        .addField('port', '#node-input-port', HLS.UI.Validators.validatePort)
        .addField('devicePort', '#node-input-devicePort', HLS.UI.Validators.validatePort)
        .addField('timeout', '#node-input-timeout', HLS.UI.Validators.validateTimeout);
      
      // Initialize data points table
      this.dataPointsTable = new HLS.UI.DataPointsTable('#data-points-section', {
        showDefaultValue: false,
        showReadWrite: false
      });
      
      // Load existing addresses
      if (this.addresses) {
        this.dataPointsTable.setDataPoints(this.addresses);
      }
      
      // Initialize connection tester
      this.connectionTester = new HLS.UI.ConnectionTester();
      
      // Bind connection test button
      $('#test-connection-btn').on('click', function() {
        const config = {
          protocol: $('#node-input-protocol').val(),
          host: $('#node-input-deviceId').val(),
          port: parseInt($('#node-input-devicePort').val()),
          timeout: parseInt($('#node-input-timeout').val())
        };
        
        if (self.validator.validateAll()) {
          self.connectionTester.test(config);
        } else {
          alert('请先修复配置错误');
        }
      });
      
      // Template selector change handler
      $('#template-selector').on('change', function() {
        const templateName = $(this).val();
        if (templateName && templateName !== '') {
          const template = HLS.UI.Templates.getTemplate(templateName);
          if (template) {
            self.applyTemplate(template);
          }
        }
      });
      
      // Import/Export buttons
      $('#export-config-btn').on('click', function() {
        const config = self.getConfiguration();
        HLS.UI.ImportExport.exportConfiguration(config, 'hls-read-config.json');
      });
      
      $('#import-config-btn').on('click', function() {
        HLS.UI.ImportExport.importConfiguration(function(err, config) {
          if (err) {
            alert('导入失败: ' + err.message);
          } else {
            self.applyConfiguration(config);
          }
        });
      });
      
      // Collapsible sections
      $('.hls-form-section-toggle').on('click', function() {
        const section = $(this).closest('.hls-form-section');
        section.toggleClass('collapsed');
        const icon = $(this).find('i');
        icon.toggleClass('fa-chevron-down fa-chevron-up');
      });
    },
    
    applyTemplate: function(template) {
      if (template.device) {
        $('#node-input-protocol').val(template.device.protocol);
        $('#node-input-deviceId').val(template.device.host);
        $('#node-input-devicePort').val(template.device.port);
        $('#node-input-timeout').val(template.device.timeout);
      }
      
      if (template.dataPoints) {
        this.dataPointsTable.setDataPoints(template.dataPoints);
      }
      
      // Trigger validation
      this.validator.validateAll();
    },
    
    applyConfiguration: function(config) {
      this.applyTemplate(config);
      
      // Apply additional node-specific settings
      if (config.name) $('#node-input-name').val(config.name);
      if (config.interval) $('#node-input-interval').val(config.interval);
      if (config.server) $('#node-input-server').val(config.server);
      if (config.port) $('#node-input-port').val(config.port);
    },
    
    getConfiguration: function() {
      return {
        name: $('#node-input-name').val(),
        device: {
          protocol: $('#node-input-protocol').val(),
          host: $('#node-input-deviceId').val(),
          port: parseInt($('#node-input-devicePort').val()),
          timeout: parseInt($('#node-input-timeout').val())
        },
        connection: {
          server: $('#node-input-server').val(),
          port: parseInt($('#node-input-port').val())
        },
        reading: {
          interval: parseInt($('#node-input-interval').val())
        },
        dataPoints: this.dataPointsTable.getDataPoints()
      };
    },
    oneditsave: function () {
      // Validate all fields before saving
      if (!this.validator.validateAll()) {
        // Prevent saving if validation fails
        return false;
      }
      
      // Save data points configuration
      this.addresses = this.dataPointsTable.getDataPoints();
      
      // Clean up
      delete this.validator;
      delete this.dataPointsTable;
      delete this.connectionTester;
    },
    
    oneditcancel: function() {
      // Clean up on cancel
      if (this.validator) delete this.validator;
      if (this.dataPointsTable) delete this.dataPointsTable;
      if (this.connectionTester) delete this.connectionTester;
    },
  });
</script>

<script type="text/html" data-template-name="hls-read">
  <!-- Template Selector -->
  <div class="hls-template-selector">
    <label for="template-selector"><i class="fa fa-magic"></i> 快速配置模板：</label>
    <select id="template-selector">
      <option value="">请选择模板...</option>
      <option value="modbus-tcp">Modbus TCP 默认配置</option>
      <option value="opc-ua">OPC UA 默认配置</option>
    </select>
    <button type="button" id="import-config-btn" class="hls-btn hls-btn-secondary">
      <i class="fa fa-upload"></i> 导入配置
    </button>
    <button type="button" id="export-config-btn" class="hls-btn hls-btn-secondary">
      <i class="fa fa-download"></i> 导出配置
    </button>
  </div>

  <!-- Basic Configuration -->
  <div class="hls-form-section">
    <div class="hls-form-section-header">
      基础配置
      <span class="hls-form-section-toggle"><i class="fa fa-chevron-down"></i></span>
    </div>
    <div class="hls-form-section-content">
      <div class="hls-form-row">
        <label class="hls-form-label" for="node-input-name"><i class="fa fa-tag"></i> 节点名称：</label>
        <div class="hls-form-control">
          <input type="text" id="node-input-name" placeholder="HLS读取节点" />
        </div>
      </div>
    </div>
  </div>

  <!-- HLS Communication Service Configuration -->
  <div class="hls-form-section">
    <div class="hls-form-section-header">
      HLS通信服务配置
      <span class="hls-form-section-toggle"><i class="fa fa-chevron-down"></i></span>
    </div>
    <div class="hls-form-section-content">
      <div class="hls-form-row">
        <label class="hls-form-label" for="node-input-server"><i class="fa fa-server"></i> 服务地址：</label>
        <div class="hls-form-control">
          <input type="text" id="node-input-server" placeholder="localhost" />
        </div>
      </div>
      <div class="hls-form-row">
        <label class="hls-form-label" for="node-input-port"><i class="fa fa-plug"></i> 服务端口：</label>
        <div class="hls-form-control">
          <input type="number" id="node-input-port" placeholder="8888" min="1" max="65535" />
        </div>
      </div>
      <div class="hls-form-row">
        <label class="hls-form-label" for="node-input-timeout"><i class="fa fa-clock-o"></i> 超时时间：</label>
        <div class="hls-form-control">
          <input type="number" id="node-input-timeout" placeholder="5000" min="1000" max="60000" />
          <small>毫秒 (1000-60000)</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Target Device Configuration -->
  <div class="hls-form-section">
    <div class="hls-form-section-header">
      目标设备配置
      <span class="hls-form-section-toggle"><i class="fa fa-chevron-down"></i></span>
    </div>
    <div class="hls-form-section-content">
      <div class="hls-form-row">
        <label class="hls-form-label" for="node-input-deviceId"><i class="fa fa-microchip"></i> 设备IP：</label>
        <div class="hls-form-control">
          <input type="text" id="node-input-deviceId" placeholder="192.168.1.100" />
        </div>
      </div>
      <div class="hls-form-row">
        <label class="hls-form-label" for="node-input-protocol"><i class="fa fa-cogs"></i> 通信协议：</label>
        <div class="hls-form-control">
          <select id="node-input-protocol">
            <option value="ModbusTcp">Modbus TCP</option>
            <option value="OpcUa">OPC UA</option>
          </select>
        </div>
      </div>
      <div class="hls-form-row">
        <label class="hls-form-label" for="node-input-devicePort"><i class="fa fa-plug"></i> 设备端口：</label>
        <div class="hls-form-control">
          <input type="number" id="node-input-devicePort" placeholder="502" min="1" max="65535" />
        </div>
      </div>
      <div class="hls-form-row">
        <div class="hls-form-control">
          <button type="button" id="test-connection-btn" class="hls-btn hls-btn-primary">
            <i class="fa fa-plug"></i> 测试连接
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reading Configuration -->
  <div class="hls-form-section">
    <div class="hls-form-section-header">
      读取配置
      <span class="hls-form-section-toggle"><i class="fa fa-chevron-down"></i></span>
    </div>
    <div class="hls-form-section-content">
      <div class="hls-form-row">
        <label class="hls-form-label" for="node-input-interval"><i class="fa fa-refresh"></i> 读取间隔：</label>
        <div class="hls-form-control">
          <input type="number" id="node-input-interval" placeholder="1000" min="100" max="60000" />
          <small>毫秒 (100-60000)</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Points Configuration -->
  <div class="hls-form-section">
    <div class="hls-form-section-header">
      数据点配置
      <span class="hls-form-section-toggle"><i class="fa fa-chevron-down"></i></span>
    </div>
    <div class="hls-form-section-content">
      <div id="data-points-section"></div>
    </div>
  </div>
</script>

<script type="text/html" data-help-name="hls-read">
  <p>从工业设备读取数据的Node-RED节点</p>

  <h3>配置</h3>
  <dl class="message-properties">
    <dt>设备ID <span class="property-type">字符串</span></dt>
    <dd>要连接的设备标识符</dd>

    <dt>服务器 <span class="property-type">字符串</span></dt>
    <dd>HLS-Communication服务器地址，默认127.0.0.1</dd>

    <dt>端口 <span class="property-type">数字</span></dt>
    <dd>HLS-Communication服务器端口，默认8888</dd>

    <dt>间隔 <span class="property-type">数字</span></dt>
    <dd>读取间隔，单位毫秒，默认1000</dd>

    <dt>数据点配置 <span class="property-type">数组</span></dt>
    <dd>要读取的数据点地址、类型和描述</dd>
  </dl>

  <h3>输入</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">对象</span></dt>
    <dd>触发读取操作的消息。可以包含动态的设备配置或地址列表。</dd>
  </dl>

  <h3>输出</h3>
  <dl class="message-properties">
    <dt>payload <span class="property-type">对象</span></dt>
    <dd>包含读取结果的消息对象</dd>
    <dt>payload.deviceId <span class="property-type">字符串</span></dt>
    <dd>设备标识符</dd>
    <dt>payload.timestamp <span class="property-type">字符串</span></dt>
    <dd>数据读取时间戳</dd>
    <dt>payload.data <span class="property-type">数组</span></dt>
    <dd>读取的数据点数组</dd>
    <dt>payload.status <span class="property-type">字符串</span></dt>
    <dd>操作状态：success/error</dd>
  </dl>

  <h3>详细信息</h3>
  <p>
    此节点通过TCP Socket与HLS-Communication服务通信，实现对工业设备的数据读取。
    支持多种数据类型和批量读取操作。
  </p>
</script>
