# 技术架构文档：数采盒子与设备数据采集框架

## 概述
本文档为设备数据采集框架项目提供了最新的技术架构设计。它定义了系统的核心组件、模块间的交互方式，并提出了针对 Node.js 与 C#/Java 跨语言通信的技术解决方案，同时考虑了设备的动态配置和数据点的批量操作，旨在为后续的开发工作提供清晰的指导。

## 总体架构
整个框架将采用一种双进程架构，由两个主要部分组成：

HLS-Communication 核心服务：这是一个独立的后台进程，由 C# 或 Java 编写，负责处理所有底层设备协议通信、动态设备配置管理以及数据点的批量读写操作。

Node-RED 环境与定制节点：提供用户界面和数据流编排能力，其中定制节点（hls-read 和 hls-write）将作为客户端，直接通过 IPC 机制与 HLS-Communication 核心服务通信。

## 核心技术方案：跨语言通信
鉴于 Node-RED（Node.js）与 hlscommunication（C#/Java）之间的语言不兼容性，我们推荐采用 **IPC（进程间通信）**方案，使 Node-RED 直接与核心服务通信。

实现方式：HLS-Communication 核心服务将以一个独立的后台服务形式运行，并监听一个本地的 TCP/IP Socket 端口。

通信协议：Node-RED 定制节点将作为客户端，通过这个本地 Socket 端口发送和接收数据。为了支持批量操作，通信数据格式将采用轻量级的 JSON 或 Protocol Buffers，以保证数据传输效率和可扩展性。

## 模块设计
HLS-Communication 核心服务

职责：专注于底层设备协议解析、设备连接建立、数据采集、数据写入等核心通信功能。

动态配置：该服务将提供一个配置接口，允许 Node-RED 节点传入设备的 IP 地址、端口、协议类型等参数，来建立设备连接。

> **架构说明：** 此处的"动态配置"指通过IPC接口接收Node-RED传来的连接参数并建立设备连接，不包括复杂的设备管理、监控或状态管理功能。设备的采集调度、异常处理、重连策略等由Node-RED流程负责，HLS服务专注于提供基础的设备通信能力。

接口：对外提供一套清晰的 API 接口，通过 Socket 接收和响应请求，重点支持批量操作：

批量读取：接收一个包含多个点位地址、数据类型等信息的列表，一次性返回所有点位的数据集合。

批量写入：接收一个包含多个点位地址、写入值等信息的列表，一次性将指令写入所有目标点位。

Node-RED 定制节点 (hls-read, hls-write)

职责：提供简化的用户配置界面，用于配置设备连接参数和数据点位，并将配置转换为IPC请求发送给HLS服务。

内部逻辑：Node.js 编写，内部包含 Socket 客户端逻辑，负责与核心服务建立连接、发送请求和处理响应。设备的高级管理功能（如重连、监控、调度）由Node-RED流程层面的其他节点处理。

## 数据流和控制流

**完整的数据采集流程：**
定时器节点 → hls-read 节点（配置设备+数据点） → IPC请求（设备连接+数据读取） → HLS-Communication 核心服务 → hlscommunication框架 → 设备 → 数据返回 → hls-read 节点 → Node-RED 数据流（处理/异常检测/存储等）

**反向控制流程：**
Node-RED 控制逻辑 → hls-write 节点 → IPC请求（写入数据） → HLS-Communication 核心服务 → hlscommunication框架 → 设备 → 写入确认 → hls-write 节点 → Node-RED 后续处理

**架构优势：**
- HLS服务专注设备通信，Node-RED负责业务逻辑
- 用户通过Node-RED统一管理所有设备和数据流
- 利用hlscommunication框架支持丰富的工业协议