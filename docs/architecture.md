# 技术架构文档：数采盒子与设备数据采集框架

## 概述
本文档为设备数据采集框架项目提供了最新的技术架构设计。它定义了系统的核心组件、模块间的交互方式，并提出了针对 Node.js 与 C#/Java 跨语言通信的技术解决方案，同时考虑了设备的动态配置和数据点的批量操作，旨在为后续的开发工作提供清晰的指导。

## 总体架构
整个框架将采用一种双进程架构，由两个主要部分组成：

HLS-Communication 核心服务：这是一个独立的后台进程，由 C# 或 Java 编写，负责处理所有底层设备协议通信、动态设备配置管理以及数据点的批量读写操作。

Node-RED 环境与定制节点：提供用户界面和数据流编排能力，其中定制节点（hls-read 和 hls-write）将作为客户端，直接通过 IPC 机制与 HLS-Communication 核心服务通信。

## 核心技术方案：跨语言通信
鉴于 Node-RED（Node.js）与 hlscommunication（C#/Java）之间的语言不兼容性，我们推荐采用 **IPC（进程间通信）**方案，使 Node-RED 直接与核心服务通信。

实现方式：HLS-Communication 核心服务将以一个独立的后台服务形式运行，并监听一个本地的 TCP/IP Socket 端口。

通信协议：Node-RED 定制节点将作为客户端，通过这个本地 Socket 端口发送和接收数据。为了支持批量操作，通信数据格式将采用轻量级的 JSON 或 Protocol Buffers，以保证数据传输效率和可扩展性。

## 模块设计
HLS-Communication 核心服务

职责：专注于底层设备协议解析、数据采集、数据写入等功能。

动态配置：该服务将提供一个配置 API，允许 Node-RED 节点传入设备的 IP 地址、端口、协议类型等参数，来动态连接不同的设备。

接口：对外提供一套清晰的 API 接口，通过 Socket 接收和响应请求，重点支持批量操作：

批量读取：接收一个包含多个点位地址、数据类型等信息的列表，一次性返回所有点位的数据集合。

批量写入：接收一个包含多个点位地址、写入值等信息的列表，一次性将指令写入所有目标点位。

Node-RED 定制节点 (hls-read, hls-write)

职责：提供用户配置界面（如 UI/UX 规范中所述），并将用户的配置和数据点位列表转换为 IPC 请求。

内部逻辑：Node.js 编写，内部包含 Socket 客户端逻辑，负责与核心服务建立连接、发送批量请求和处理批量响应。

## 数据流和控制流
数据采集（hls-read）：
hls-read 节点 (JS) → Socket 请求（包含点位列表）→ HLS-Communication 核心服务 (C#/Java) → 批量读取设备数据 → 返回 Socket 响应（包含数据集合） → hls-read 节点 (JS) → 进入 Node-RED 数据流。

反向控制（hls-write）：
Node-RED 数据流 → hls-write 节点 (JS) → Socket 请求（包含点位列表和写入值） → HLS-Communication 核心服务 (C#/Java) → 批量写入设备数据 → 返回 Socket 响应。