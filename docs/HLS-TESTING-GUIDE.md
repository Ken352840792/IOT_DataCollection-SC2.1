# HLS 通信节点测试指南

本指南将帮助您完成 HLS-Read 和 HLS-Write 节点与 Modbus 设备的通信测试。

## 测试环境准备

### 1. 启动 HLS 通信服务

```bash
# 进入 HlsService 目录
cd src/hls-service/HlsService

# 启动服务
dotnet run
```

服务启动后应该显示：
```
=== HLS-Communication IPC 服务 ===
[配置] 监听地址: 127.0.0.1:8888
[配置] 最大连接数: 50
[系统] 服务已启动，使用 Ctrl+C 退出
```

### 2. 启动 Modbus TCP 模拟器

您可以使用以下任意一种 Modbus 模拟器：

**推荐模拟器：**
- ModbusPal (免费)
- Modbus Slave (付费，功能强大)
- pymodbus 模拟器 (Python)

**配置要求：**
- 协议：Modbus TCP
- 端口：502
- 设备地址：1 (或根据模拟器默认)

**测试寄存器设置：**
```
40001 - 温度传感器值 (Int16) - 建议初始值: 25
40002 - 湿度传感器值 (Int16) - 建议初始值: 60  
40003 - 压力传感器值 (Float) - 建议初始值: 1.5
40010 - 可写入的设定值1 (Int16)
40011 - 可写入的设定值2 (Int16)
```

### 3. 部署 HLS 节点到 Node-RED

```bash
# 进入节点目录
cd src/nodes

# 安装依赖
npm install

# 启动 Node-RED (如果还未启动)
npm run dev
```

或者手动链接节点：
```bash
# 在 Node-RED 用户目录中创建链接
cd ~/.node-red
npm link /path/to/your/project/src/nodes
```

### 4. 导入测试流程

1. 打开 Node-RED 界面 (通常是 http://localhost:1880)
2. 点击右上角菜单 → Import
3. 选择 "select a file to import" 或直接粘贴 JSON
4. 导入文件：`docs/node-red-test-flow.json`
5. 点击 "Deploy" 部署流程

## 测试步骤

### 手动测试

1. **连接状态检查**
   - 观察 HLS-Read 和 HLS-Write 节点的状态指示器
   - 绿色圆点表示已连接，红色圆圈表示未连接

2. **读取测试**
   - 点击 "手动触发读取" 注入节点
   - 查看 "读取结果" Debug 输出
   - 应该显示类似：
   ```json
   {
     "connectionId": "xxx-xxx-xxx",
     "data": [
       {"address": "40001", "value": 25, "dataType": "Int16", "quality": "Good"},
       {"address": "40002", "value": 60, "dataType": "Int16", "quality": "Good"}
     ],
     "timestamp": "2024-xx-xx...",
     "status": "success"
   }
   ```

3. **写入测试**
   
   **单个值写入：**
   - 点击 "写入单个值" 注入节点
   - 观察 "写入成功" Debug 输出
   
   **批量写入：**
   - 点击 "批量写入" 注入节点
   - 应该同时写入多个寄存器
   
   **映射格式写入：**
   - 点击 "映射格式写入" 注入节点
   - 使用地址-值映射格式

4. **自动读取测试**
   - 点击 "自动读取(5秒)" 注入节点
   - 观察数据每5秒自动刷新

### 自动化测试

1. 点击 "执行测试序列" 注入节点
2. 系统将自动执行：
   - 读取操作
   - 写入单个值
   - 验证写入结果
   - 批量写入
   - 最终验证

## 预期结果

### 正常情况

**HLS Service 控制台应显示：**
```
[IPC] 新客户端连接: xxx.xxx.xxx.xxx:port
[连接] 设备连接成功: 127.0.0.1:502
[读取] 成功读取 3 个数据点
[写入] 成功写入数据点 40010, 值: 30
```

**Node-RED Debug 输出应显示：**
- 读取操作成功返回数据
- 写入操作返回确认信息
- 处理后的数据格式正确

### 错误情况处理

**常见错误及解决方案：**

1. **连接失败**
   ```
   连接失败: 无法连接到目标设备
   ```
   - 检查 Modbus 模拟器是否运行在端口 502
   - 确认 HlsService 是否正在运行

2. **通信超时**
   ```
   请求超时
   ```
   - 检查网络连接
   - 增加超时时间设置

3. **节点未找到**
   ```
   Unknown node type: hls-read
   ```
   - 确认节点已正确安装
   - 重启 Node-RED 服务

## 高级测试

### 性能测试

1. 修改读取间隔为更小值 (如 100ms)
2. 增加更多数据点
3. 观察系统响应时间和稳定性

### 错误恢复测试

1. 在运行过程中停止 Modbus 模拟器
2. 观察节点状态变化和错误处理
3. 重新启动模拟器，观察自动重连

### 数据验证测试

1. 在模拟器中修改寄存器值
2. 观察 Node-RED 中读取的数据是否实时更新
3. 执行写入操作后，在模拟器中验证值是否正确写入

## 故障排除

### 检查清单

- [ ] HlsService 正在运行 (端口 8888)
- [ ] Modbus 模拟器正在运行 (端口 502)
- [ ] Node-RED 节点已正确部署
- [ ] 防火墙未阻止相关端口
- [ ] IP 地址配置正确 (127.0.0.1)

### 日志分析

**HlsService 日志位置：**
- 控制台输出
- 可通过按 's' 查看详细状态

**Node-RED 日志位置：**
- Debug 侧边栏
- 浏览器开发者工具控制台

### 联系支持

如果遇到问题，请提供：
1. 完整的错误消息
2. HlsService 控制台输出
3. Node-RED Debug 输出
4. 操作系统和环境信息

---

*测试完成后，您可以基于这个示例流程创建自己的工业自动化应用。*