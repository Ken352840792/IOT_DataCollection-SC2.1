# 故事2.5：通信协议和API设计

## 状态
**Draft**

## 故事
**作为** Node-RED开发者  
**我希望** 有清晰的通信协议规范  
**以便** 能够正确地与HLS-Communication服务交互

## 验收标准

1. **标准化JSON通信协议定义**
   - 定义完整的JSON请求/响应格式规范
   - 实现协议版本控制和向后兼容性
   - 提供消息ID机制确保请求响应匹配
   - 建立统一的错误码和错误信息体系

2. **连接管理API接口规范**
   - 实现设备连接建立和断开的基础API
   - 提供连接状态查询接口
   - 建立连接参数验证和错误处理机制

3. **数据操作API接口规范**
   - 实现单点和批量数据读取API
   - 实现单点和批量数据写入API
   - 建立数据操作的错误处理和状态反馈

4. **基础API文档和示例**
   - 编写核心API参考文档
   - 提供常用场景的使用示例
   - 建立API测试套件和验证工具

## 任务/子任务

- [ ] **JSON协议规范制定** (AC: 1)
  - [ ] 设计标准的消息格式结构（请求/响应）
  - [ ] 定义协议版本号和兼容性规则
  - [ ] 实现消息ID生成和跟踪机制
  - [ ] 建立错误码分类和标准化错误信息
  - [ ] 添加消息验证和格式检查
  - [ ] 创建协议规范文档

- [ ] **连接管理API实现** (AC: 2)
  - [ ] 实现基础设备连接API（connect/disconnect）
  - [ ] 开发连接状态查询API
  - [ ] 创建连接参数验证API
  - [ ] 添加连接错误处理和状态码定义
  - [ ] 建立连接会话管理机制

- [ ] **数据操作API实现** (AC: 3)
  - [ ] 实现数据读取API（单点和批量）
  - [ ] 开发数据写入API（单点和批量）
  - [ ] 添加数据操作的错误处理和状态码
  - [ ] 实现数据格式验证和类型转换
  - [ ] 建立数据操作的响应格式标准

- [ ] **文档和工具开发** (AC: 4)
  - [ ] 编写核心API参考文档
  - [ ] 创建基础API使用示例
  - [ ] 建立API测试工具和验证套件
  - [ ] 提供基础的故障排除指南

## 开发注意事项

### 相关源码树信息
- API控制器: `src/hls-service/api/controllers/`
- 协议定义: `src/hls-service/protocol/`
- SDK开发: `sdk/nodejs/`
- API文档: `docs/api/`

### 技术要求
根据架构文档的API设计需求：
- **通信协议：** Node-RED定制节点通过Socket端口发送和接收数据
- **数据格式：** 轻量级的JSON或Protocol Buffers格式
- **API接口：** 提供清晰的API接口，重点支持批量操作
- **错误处理：** 完善的错误码和错误信息规范

### API接口分类

#### 1. 连接管理IPC接口
```json
// 连接建立
{
  "action": "connect",
  "deviceConfig": {...},
  "dataPoints": [...]
}

// 连接断开  
{
  "action": "disconnect",
  "connectionId": "conn_001"
}

// 状态查询
{
  "action": "status",
  "connectionId": "conn_001"
}
```

#### 2. 数据操作IPC接口
```json
// 读取数据
{
  "action": "read",
  "connectionId": "conn_001",
  "dataPoints": ["40001", "40002"]
}

// 写入数据
{
  "action": "write", 
  "connectionId": "conn_001",
  "dataPoints": [
    {"address": "40001", "value": 100}
  ]
}
```

### JSON协议格式规范

#### 通用请求格式
```json
{
  "version": "1.0",
  "messageId": "uuid",
  "timestamp": "2025-08-25T10:00:00Z",
  "command": "connect|disconnect|read|write|status",
  "data": {
    // 具体命令的数据内容
  }
}
```

#### 通用响应格式
```json
{
  "version": "1.0", 
  "messageId": "uuid",
  "timestamp": "2025-08-25T10:00:01Z",
  "success": true|false,
  "data": {
    // 响应数据内容
  },
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": "详细错误信息"
  }
}
```

### 错误码规范
```javascript
const ErrorCodes = {
  // 系统级错误 (1xxx)
  SYSTEM_ERROR: 1000,
  INVALID_REQUEST: 1001,
  INVALID_PARAMETER: 1002,
  PERMISSION_DENIED: 1003,
  
  // 设备连接错误 (2xxx)
  DEVICE_NOT_FOUND: 2001,
  DEVICE_OFFLINE: 2002,
  CONNECTION_TIMEOUT: 2003,
  CONNECTION_FAILED: 2004,
  
  // 数据操作错误 (3xxx)
  INVALID_ADDRESS: 3001,
  DATA_TYPE_ERROR: 3002,
  READ_TIMEOUT: 3003,
  WRITE_FAILED: 3004
};
```

### 基础IPC客户端设计
```javascript
class HLSIPCClient {
  constructor(options) {
    this.host = options.host || 'localhost';
    this.port = options.port || 8888;
    this.timeout = options.timeout || 5000;
  }
  
  async connect() { /* 建立IPC连接 */ }
  async disconnect() { /* 断开IPC连接 */ }
  
  // 核心操作
  async connectDevice(deviceConfig, dataPoints) { /* 连接设备 */ }
  async disconnectDevice(connectionId) { /* 断开设备 */ }
  async getConnectionStatus(connectionId) { /* 获取连接状态 */ }
  
  // 数据操作  
  async readData(connectionId, addresses) { /* 读取数据 */ }
  async writeData(connectionId, dataPoints) { /* 写入数据 */ }
}
```

### 基础性能要求
- **响应时间：** IPC调用响应时间 < 100ms
- **批量限制：** 单次批量操作 ≤ 100个数据点
- **连接管理：** 支持最多10个并发设备连接

### 测试
#### 测试标准
- IPC协议通信测试覆盖核心功能
- 错误处理和状态码验证
- 基础性能要求验证
- 文档和示例可用性测试

#### 测试要求
- 自动化IPC接口测试
- 协议版本兼容性测试
- 错误场景的处理验证
- 基础性能测试

## 变更日志

| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-08-26 | 2.0 | 架构简化，移除复杂设备管理API，专注IPC通信 | Sarah (PO) |
| 2025-08-25 | 1.0 | 初始故事创建 | Sarah (PO) |

## 开发代理记录
*此部分将在开发实施时由开发代理填写*

## QA结果
*此部分将在QA验证时填写*