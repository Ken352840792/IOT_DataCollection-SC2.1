# 故事2.5：通信协议和API设计

## 状态

**Active**

## 故事

**作为** Node-RED开发者  
**我希望** 有清晰的通信协议规范  
**以便** 能够正确地与HLS-Communication服务交互

## 验收标准

1. **标准化JSON通信协议定义**
   - 定义完整的JSON请求/响应格式规范
   - 实现协议版本控制和向后兼容性
   - 提供消息ID机制确保请求响应匹配
   - 建立统一的错误码和错误信息体系

2. **连接管理API接口规范**
   - 实现设备连接建立和断开的基础API
   - 提供连接状态查询接口
   - 建立连接参数验证和错误处理机制

3. **数据操作API接口规范**
   - 实现单点和批量数据读取API
   - 实现单点和批量数据写入API
   - 建立数据操作的错误处理和状态反馈

4. **基础API文档和示例**
   - 编写核心API参考文档
   - 提供常用场景的使用示例
   - 建立API测试套件和验证工具

## 任务/子任务

- [x] **JSON协议规范制定** (AC: 1)
  - [x] 设计标准的消息格式结构（请求/响应）
  - [x] 定义协议版本号和兼容性规则
  - [x] 实现消息ID生成和跟踪机制
  - [x] 建立错误码分类和标准化错误信息
  - [x] 添加消息验证和格式检查
  - [x] 创建协议规范文档

- [x] **连接管理API实现** (AC: 2)
  - [x] 实现基础设备连接API（connect/disconnect）
  - [x] 开发连接状态查询API
  - [x] 创建连接参数验证API
  - [x] 添加连接错误处理和状态码定义
  - [x] 建立连接会话管理机制

- [x] **数据操作API实现** (AC: 3)
  - [x] 实现数据读取API（单点和批量）
  - [x] 开发数据写入API（单点和批量）
  - [x] 添加数据操作的错误处理和状态码
  - [x] 实现数据格式验证和类型转换
  - [x] 建立数据操作的响应格式标准

- [x] **文档和工具开发** (AC: 4)
  - [x] 编写核心API参考文档
  - [x] 创建基础API使用示例
  - [x] 建立API测试工具和验证套件
  - [x] 提供基础的故障排除指南

## 开发注意事项

### 相关源码树信息

- API控制器: `src/hls-service/api/controllers/`
- 协议定义: `src/hls-service/protocol/`
- SDK开发: `sdk/nodejs/`
- API文档: `docs/api/`

### 技术要求

根据架构文档的API设计需求：

- **通信协议：** Node-RED定制节点通过Socket端口发送和接收数据
- **数据格式：** 轻量级的JSON或Protocol Buffers格式
- **API接口：** 提供清晰的API接口，重点支持批量操作
- **错误处理：** 完善的错误码和错误信息规范

### API接口分类

#### 1. 连接管理IPC接口

```json
// 连接建立
{
  "action": "connect",
  "deviceConfig": {...},
  "dataPoints": [...]
}

// 连接断开
{
  "action": "disconnect",
  "connectionId": "conn_001"
}

// 状态查询
{
  "action": "status",
  "connectionId": "conn_001"
}
```

#### 2. 数据操作IPC接口

```json
// 读取数据
{
  "action": "read",
  "connectionId": "conn_001",
  "dataPoints": ["40001", "40002"]
}

// 写入数据
{
  "action": "write",
  "connectionId": "conn_001",
  "dataPoints": [
    {"address": "40001", "value": 100}
  ]
}
```

### JSON协议格式规范

#### 通用请求格式

```json
{
  "version": "1.0",
  "messageId": "uuid",
  "timestamp": "2025-08-25T10:00:00Z",
  "command": "connect|disconnect|read|write|status",
  "data": {
    // 具体命令的数据内容
  }
}
```

#### 通用响应格式

```json
{
  "version": "1.0",
  "messageId": "uuid",
  "timestamp": "2025-08-25T10:00:01Z",
  "success": true|false,
  "data": {
    // 响应数据内容
  },
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": "详细错误信息"
  }
}
```

### 错误码规范

```javascript
const ErrorCodes = {
  // 系统级错误 (1xxx)
  SYSTEM_ERROR: 1000,
  INVALID_REQUEST: 1001,
  INVALID_PARAMETER: 1002,
  PERMISSION_DENIED: 1003,

  // 设备连接错误 (2xxx)
  DEVICE_NOT_FOUND: 2001,
  DEVICE_OFFLINE: 2002,
  CONNECTION_TIMEOUT: 2003,
  CONNECTION_FAILED: 2004,

  // 数据操作错误 (3xxx)
  INVALID_ADDRESS: 3001,
  DATA_TYPE_ERROR: 3002,
  READ_TIMEOUT: 3003,
  WRITE_FAILED: 3004,
};
```

### 基础IPC客户端设计

```javascript
class HLSIPCClient {
  constructor(options) {
    this.host = options.host || 'localhost';
    this.port = options.port || 8888;
    this.timeout = options.timeout || 5000;
  }

  async connect() {
    /* 建立IPC连接 */
  }
  async disconnect() {
    /* 断开IPC连接 */
  }

  // 核心操作
  async connectDevice(deviceConfig, dataPoints) {
    /* 连接设备 */
  }
  async disconnectDevice(connectionId) {
    /* 断开设备 */
  }
  async getConnectionStatus(connectionId) {
    /* 获取连接状态 */
  }

  // 数据操作
  async readData(connectionId, addresses) {
    /* 读取数据 */
  }
  async writeData(connectionId, dataPoints) {
    /* 写入数据 */
  }
}
```

### 基础性能要求

- **响应时间：** IPC调用响应时间 < 100ms
- **批量限制：** 单次批量操作 ≤ 100个数据点
- **连接管理：** 支持最多10个并发设备连接

### 测试

#### 测试标准

- IPC协议通信测试覆盖核心功能
- 错误处理和状态码验证
- 基础性能要求验证
- 文档和示例可用性测试

#### 测试要求

- 自动化IPC接口测试
- 协议版本兼容性测试
- 错误场景的处理验证
- 基础性能测试

## 变更日志

| 日期       | 版本 | 描述                                       | 作者       |
| ---------- | ---- | ------------------------------------------ | ---------- |
| 2025-08-26 | 2.0  | 架构简化，移除复杂设备管理API，专注IPC通信 | Sarah (PO) |
| 2025-08-25 | 1.0  | 初始故事创建                               | Sarah (PO) |

## 开发代理记录

### 使用的代理模型
Claude Sonnet 4

### 完成的任务

#### JSON协议规范制定 ✅ (2025-08-26)

1. **消息格式结构**: 
   - 实现了标准化的IpcRequest和IpcResponse模型
   - 支持版本控制、消息ID、时间戳、命令和数据载荷
   - 位置：`Models/MessageModels.cs`, `Models/ProtocolModels.cs`

2. **协议版本管理**:
   - 实现版本兼容性检查和特性管理
   - 当前版本：1.0，支持向后兼容
   - 位置：`Models/ProtocolModels.cs`

3. **消息ID和跟踪**:
   - 实现UUID和自定义格式消息ID生成
   - 支持消息验证和格式检查
   - 位置：`Models/ProtocolModels.cs`

4. **错误处理系统**:
   - 建立数字化错误码分类（1xxx系统级，2xxx连接级，3xxx数据级等）
   - 实现ErrorFactory用于创建标准化错误响应
   - 支持重试机制和详细错误信息
   - 位置：`Models/ErrorModels.cs`

5. **协议文档**:
   - 创建完整的协议规范文档，包含示例和用法
   - 位置：`docs/api/protocol-specification.md`

#### 连接管理API实现 ✅ (2025-08-26)

1. **标准化API控制器**:
   - 创建ConnectionController实现所有连接管理功能
   - 支持connect、disconnect、status、listConnections、validateConnection命令
   - 位置：`Api/Controllers/ConnectionController.cs`

2. **消息处理器升级**:
   - 更新MessageProcessor使用新的标准化协议
   - 实现命令路由到相应控制器
   - 保持向后兼容性
   - 位置：`Services/MessageProcessor.cs`

3. **连接会话管理**:
   - 集成现有DeviceManager进行会话管理
   - 支持自动连接ID生成和设备生命周期管理
   - 最大并发连接数限制：10个

4. **参数验证和错误处理**:
   - 实现完整的连接参数验证
   - 标准化错误响应和状态码
   - 支持数据点配置验证

#### 数据操作API实现 ✅ (2025-08-26)

1. **数据操作控制器**:
   - 创建DataOperationController实现数据读写功能
   - 支持read、write、readBatch、writeBatch命令
   - 位置：`Api/Controllers/DataOperationController.cs`

2. **数据类型转换和验证**:
   - 实现完整的JSON数据类型转换系统
   - 支持Bool、Int16/32/64、UInt16/32/64、Float、Double、String类型
   - 包含JsonElement处理和标准类型转换
   - 提供详细的转换错误信息

3. **批量操作支持**:
   - 实现单点和批量数据读写
   - 支持最多100个数据点的批量操作
   - 包含操作汇总和统计信息

4. **响应格式标准化**:
   - 标准化数据操作响应格式
   - 包含成功/失败统计、响应时间、时间戳
   - 详细的错误信息和地址级别的操作结果

#### 文档和工具开发 ✅ (2025-08-26)

1. **API参考文档**:
   - 创建完整的API参考文档，涵盖所有11个支持的命令
   - 详细的参数说明、响应格式和示例
   - 位置：`docs/api/api-reference.md`

2. **使用示例**:
   - 提供Node.js和Python客户端示例
   - 包含Node-RED集成模式和最佳实践
   - 涵盖连接管理、数据操作、错误处理等场景
   - 位置：`docs/api/usage-examples.md`

3. **测试工具和验证套件**:
   - 创建协议v1.0完整功能测试脚本
   - 支持所有API功能的自动化测试
   - 包含性能测试和错误场景验证
   - 位置：`test_protocol_v1.js`

4. **故障排除指南**:
   - 创建详细的故障排除文档
   - 包含常见错误代码、网络问题、性能优化等
   - 提供调试工具推荐和日志分析指南
   - 位置：`docs/api/troubleshooting.md`

### 调试日志引用

- 编译问题修复：DeviceConfiguration属性结构适配
- ErrorResponse模型类型匹配修复
- 测试文件错误修复：MessageModels中重复定义清理

### 完成注释列表

1. ✅ JSON协议完整实现，包括消息格式、版本控制、ID生成、错误处理
2. ✅ 连接管理API完整实现，包括所有CRUD操作和验证功能
3. ✅ 数据操作API完整实现，包括单点批量读写、类型转换、数据验证
4. ✅ 标准化错误处理系统，支持分类错误码和详细错误信息
5. ✅ 协议规范文档完整，包含使用示例和故障排除指南
6. ✅ 测试脚本创建，支持协议v1.0完整功能验证
7. ✅ 完整文档套件，包含API参考、使用示例、故障排除指南

### 文件列表

#### 新增文件
- `Api/Controllers/ConnectionController.cs` - 连接管理API控制器
- `Api/Controllers/DataOperationController.cs` - 数据操作API控制器
- `docs/api/protocol-specification.md` - 协议规范文档
- `docs/api/api-reference.md` - API参考文档
- `docs/api/usage-examples.md` - 使用示例文档
- `docs/api/troubleshooting.md` - 故障排除指南
- `test_protocol_v1.js` - 协议测试脚本

#### 修改文件
- `Models/ProtocolModels.cs` - 协议版本和验证逻辑
- `Models/ErrorModels.cs` - 错误处理和工厂模式
- `Models/MessageModels.cs` - 消息模型结构
- `Services/MessageProcessor.cs` - 消息路由和处理
- `Tests/DeviceManagementTests.cs` - 测试错误修复
- `Models/DataPointModels.cs` - 重复定义清理

### 变更日志

| 日期       | 版本 | 描述                                                         | 作者           |
| ---------- | ---- | ------------------------------------------------------------ | -------------- |
| 2025-08-26 | 2.2  | Story 2.5完全完成：实现完整的通信协议和API系统，包含数据操作API、文档套件和故障排除指南 | James (Dev AI) |
| 2025-08-26 | 2.1  | 完成JSON协议规范和连接管理API实现，支持标准化v1.0协议      | James (Dev AI) |

## QA结果

_此部分将在QA验证时填写_
