# 故事2.5：通信协议和API设计

## 状态
**Draft**

## 故事
**作为** Node-RED开发者  
**我希望** 有清晰的通信协议规范  
**以便** 能够正确地与HLS-Communication服务交互

## 验收标准

1. **标准化JSON通信协议定义**
   - 定义完整的JSON请求/响应格式规范
   - 实现协议版本控制和向后兼容性
   - 提供消息ID机制确保请求响应匹配
   - 建立统一的错误码和错误信息体系

2. **设备管理API接口规范**
   - 实现设备连接、断开、状态查询API
   - 提供设备列表管理和配置接口
   - 实现设备健康检查和诊断API
   - 建立设备信息查询和元数据管理

3. **数据操作API接口规范**
   - 实现单点和批量数据读取API
   - 实现单点和批量数据写入API
   - 提供数据订阅和实时推送机制
   - 建立数据历史查询和统计接口

4. **完整的API文档和示例**
   - 编写详细的API参考文档
   - 提供各种场景的使用示例和最佳实践
   - 创建API交互的SDK和工具库
   - 建立API测试套件和验证工具

## 任务/子任务

- [ ] **JSON协议规范制定** (AC: 1)
  - [ ] 设计标准的消息格式结构（请求/响应）
  - [ ] 定义协议版本号和兼容性规则
  - [ ] 实现消息ID生成和跟踪机制
  - [ ] 建立错误码分类和标准化错误信息
  - [ ] 添加消息验证和格式检查
  - [ ] 创建协议规范文档

- [ ] **设备管理API实现** (AC: 2)
  - [ ] 实现设备连接管理API（connect/disconnect）
  - [ ] 开发设备状态查询API（status/health）
  - [ ] 创建设备配置管理API（CRUD操作）
  - [ ] 实现设备发现和枚举功能
  - [ ] 添加设备诊断和测试接口
  - [ ] 建立设备事件通知机制

- [ ] **数据操作API实现** (AC: 3)
  - [ ] 实现数据读取API（单点和批量）
  - [ ] 开发数据写入API（单点和批量）
  - [ ] 创建数据订阅和推送机制
  - [ ] 实现数据缓存和历史查询
  - [ ] 添加数据质量和时间戳管理
  - [ ] 建立数据统计和分析接口

- [ ] **文档和工具开发** (AC: 4)
  - [ ] 编写完整的API参考文档
  - [ ] 创建API使用示例和教程
  - [ ] 开发Node.js SDK和帮助库
  - [ ] 建立API测试工具和验证套件
  - [ ] 创建在线API文档和交互界面
  - [ ] 提供故障排除指南和FAQ

## 开发注意事项

### 相关源码树信息
- API控制器: `src/hls-service/api/controllers/`
- 协议定义: `src/hls-service/protocol/`
- SDK开发: `sdk/nodejs/`
- API文档: `docs/api/`

### 技术要求
根据架构文档的API设计需求：
- **通信协议：** Node-RED定制节点通过Socket端口发送和接收数据
- **数据格式：** 轻量级的JSON或Protocol Buffers格式
- **API接口：** 提供清晰的API接口，重点支持批量操作
- **错误处理：** 完善的错误码和错误信息规范

### API接口分类

#### 1. 设备管理API
```http
POST   /api/v1/devices/connect           # 连接设备
POST   /api/v1/devices/disconnect        # 断开设备
GET    /api/v1/devices                   # 获取设备列表
GET    /api/v1/devices/{id}/status       # 获取设备状态
POST   /api/v1/devices/{id}/test         # 测试设备连接
GET    /api/v1/devices/{id}/info         # 获取设备信息
```

#### 2. 数据操作API
```http
POST   /api/v1/data/read                 # 读取数据（单点/批量）
POST   /api/v1/data/write                # 写入数据（单点/批量）
POST   /api/v1/data/subscribe            # 订阅数据变化
DELETE /api/v1/data/subscribe/{id}       # 取消数据订阅
GET    /api/v1/data/history              # 查询历史数据
GET    /api/v1/data/statistics           # 获取数据统计
```

#### 3. 系统管理API
```http
GET    /api/v1/system/status             # 获取系统状态
GET    /api/v1/system/info               # 获取系统信息
POST   /api/v1/system/reset              # 重置系统
GET    /api/v1/system/logs               # 获取系统日志
```

### JSON协议格式规范

#### 通用请求格式
```json
{
  "version": "1.0",
  "messageId": "uuid",
  "timestamp": "2025-08-25T10:00:00Z",
  "command": "connect|disconnect|read|write|subscribe",
  "data": {
    // 具体命令的数据内容
  }
}
```

#### 通用响应格式
```json
{
  "version": "1.0", 
  "messageId": "uuid",
  "timestamp": "2025-08-25T10:00:01Z",
  "success": true|false,
  "data": {
    // 响应数据内容
  },
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": "详细错误信息"
  }
}
```

### 错误码规范
```javascript
const ErrorCodes = {
  // 系统级错误 (1xxx)
  SYSTEM_ERROR: 1000,
  INVALID_REQUEST: 1001,
  INVALID_PARAMETER: 1002,
  PERMISSION_DENIED: 1003,
  
  // 设备连接错误 (2xxx)
  DEVICE_NOT_FOUND: 2001,
  DEVICE_OFFLINE: 2002,
  CONNECTION_TIMEOUT: 2003,
  CONNECTION_FAILED: 2004,
  
  // 数据操作错误 (3xxx)
  INVALID_ADDRESS: 3001,
  DATA_TYPE_ERROR: 3002,
  READ_TIMEOUT: 3003,
  WRITE_FAILED: 3004
};
```

### Node.js SDK设计
```javascript
class HLSCommunicationClient {
  constructor(options) {
    this.host = options.host || 'localhost';
    this.port = options.port || 8888;
    this.timeout = options.timeout || 5000;
  }
  
  async connect() { /* 连接到服务 */ }
  async disconnect() { /* 断开连接 */ }
  
  // 设备管理
  async connectDevice(deviceConfig) { /* 连接设备 */ }
  async disconnectDevice(deviceId) { /* 断开设备 */ }
  async getDeviceStatus(deviceId) { /* 获取设备状态 */ }
  
  // 数据操作
  async readData(deviceId, addresses) { /* 读取数据 */ }
  async writeData(deviceId, data) { /* 写入数据 */ }
  async subscribeData(deviceId, addresses, callback) { /* 订阅数据 */ }
}
```

### API安全和认证
- **API Key认证：** 每个API请求需要携带有效的API密钥
- **请求签名：** 对敏感操作进行请求签名验证
- **访问控制：** 基于角色的API访问权限控制
- **审计日志：** 记录所有API调用和操作日志

### 性能和限制
- **请求频率限制：** 防止API滥用和系统过载
- **批量操作限制：** 单次批量操作的数据点数量限制
- **响应时间SLA：** API响应时间的服务水平协议
- **并发连接限制：** 最大并发API连接数

### 测试
#### 测试标准
- API接口测试覆盖率100%
- 协议兼容性测试通过
- SDK功能完整性验证
- 文档和示例可用性测试

#### 测试要求
- 自动化API测试套件
- 不同协议版本的兼容性测试
- 错误场景的处理验证
- 性能和压力测试

## 变更日志

| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-08-25 | 1.0 | 初始故事创建 | Sarah (PO) |

## 开发代理记录
*此部分将在开发实施时由开发代理填写*

## QA结果
*此部分将在QA验证时填写*