# 故事1.2：Node.js和Node-RED环境配置

## 状态
**Done**

## 故事
**作为** 开发者  
**我希望** 配置Node.js开发环境和Node-RED平台  
**以便** 开始开发定制节点和数据流编排功能

## 验收标准

1. **Node.js环境安装和配置**
   - 安装Node.js LTS版本（推荐18.x或更高版本）
   - 配置npm镜像源（如淘宝镜像）以提高下载速度
   - 验证Node.js和npm版本并记录在文档中

2. **Node-RED平台配置**
   - 全局或项目本地安装Node-RED
   - 配置Node-RED的用户目录和设置文件
   - 验证Node-RED能够正常启动并访问Web界面
   - 配置Node-RED的安全设置（用户认证、HTTPS等）

3. **定制节点开发环境准备**
   - 安装Node-RED节点开发相关的依赖包
   - 创建定制节点开发的项目结构
   - 配置节点开发和调试环境
   - 设置节点测试框架

4. **环境验证和文档**
   - 创建环境安装和配置的详细文档
   - 编写环境验证脚本
   - 记录所有版本信息和配置参数
   - 提供故障排除指南

## 任务/子任务

- [ ] **Node.js环境设置** (AC: 1)
  - [ ] 下载并安装Node.js LTS版本
  - [ ] 配置npm全局设置和镜像源
  - [ ] 验证node和npm命令可用性
  - [ ] 创建Node.js环境配置文档

- [ ] **Node-RED安装和基础配置** (AC: 2)
  - [ ] 选择安装方式（全局vs项目本地）
  - [ ] 安装Node-RED核心包
  - [ ] 配置Node-RED设置文件(settings.js)
  - [ ] 设置用户目录和数据存储位置
  - [ ] 配置Web界面访问端口和安全设置

- [ ] **Node-RED启动和验证** (AC: 2)
  - [ ] 启动Node-RED服务
  - [ ] 验证Web界面可正常访问
  - [ ] 测试基本流程创建功能
  - [ ] 配置用户认证（开发环境可选）

- [ ] **定制节点开发环境** (AC: 3)
  - [ ] 安装node-red-node-test-helper测试工具
  - [ ] 创建nodes/目录用于定制节点开发
  - [ ] 设置节点开发的package.json配置
  - [ ] 配置开发时的节点加载和调试

- [ ] **创建验证脚本和文档** (AC: 4)
  - [ ] 编写环境验证脚本(verify-environment.js)
  - [ ] 创建详细的安装配置文档
  - [ ] 记录所有软件版本和配置
  - [ ] 编写常见问题和解决方案文档

## 开发注意事项

### 相关源码树信息
- Node-RED用户目录位置: ~/.node-red/ (Linux/Mac) 或 %HOMEPATH%\\.node-red (Windows)
- 定制节点将位于项目的 nodes/ 目录
- Node-RED流程文件将保存在 flows/ 目录

### 技术要求
- Node.js版本：18.x LTS或更高
- Node-RED版本：最新稳定版(3.x系列)
- 支持跨平台运行(Windows/Linux/Mac)
- 开发环境需支持热重载和调试

### 架构考虑
- Node-RED将作为数据流编排的核心平台
- 定制节点将通过IPC与HLS-Communication服务通信
- 需要考虑多用户和权限管理（后续需求）

### 重要配置
- Node-RED设置文件需要配置:
  - 用户目录路径
  - 流程文件存储位置  
  - 安全设置和用户认证
  - 调试和日志级别
  - 函数节点的安全配置

### 测试
#### 测试标准
- 使用Node-RED内置测试框架
- 节点单元测试覆盖率>80%
- 集成测试验证Node-RED与定制节点的交互
- 性能测试验证启动时间和运行稳定性

#### 测试要求
- 环境验证脚本必须通过所有检查
- Node-RED界面在主流浏览器中正常显示
- 定制节点开发环境能够正确加载和调试节点
- 跨平台兼容性测试通过

## 变更日志

| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-08-25 | 1.0 | 初始故事创建 | Sarah (PO) |

## 开发代理记录

### 代理模型使用
Claude Sonnet 4 (claude-sonnet-4-20250514)

### 完成状态
- [x] Node.js环境设置 - 已完成（Node.js v22.12.0, npm 10.9.0）
- [x] Node-RED安装和基础配置 - 已完成
- [x] Node-RED启动和验证 - 已完成  
- [x] 定制节点开发环境 - 已完成
- [x] 创建验证脚本和文档 - 已完成

### 文件清单
**创建的文件：**
- `scripts/verify-environment.js` - 环境验证脚本
- `nodered-data/settings.js` - Node-RED配置文件
- `nodered-data/package.json` - Node-RED包配置
- `src/nodes/package.json` - 定制节点包配置
- `src/nodes/README.md` - 定制节点开发说明
- `src/nodes/hls-read/hls-read.js` - HLS读取节点逻辑
- `src/nodes/hls-read/hls-read.html` - HLS读取节点UI
- `src/nodes/hls-write/hls-write.js` - HLS写入节点逻辑
- `src/nodes/hls-write/hls-write.html` - HLS写入节点UI
- `docs/DEVELOPMENT_SETUP.md` - 开发环境设置完整指南

**创建的目录：**
- `scripts/` - 工具脚本目录
- `nodered-data/` - Node-RED用户数据目录
- `src/nodes/hls-read/` - HLS读取节点目录
- `src/nodes/hls-write/` - HLS写入节点目录
- `src/nodes/test/` - 节点测试目录

### 环境验证结果
```
✅ Node.js版本: v22.12.0 (满足>=18.0.0要求)
✅ npm版本: 10.9.0 (满足>=8.0.0要求)  
✅ Node-RED v3.1.15-git 成功安装并验证
✅ 环境验证脚本完全通过（0错误，0警告）
✅ 定制节点依赖安装成功
```

### 技术实现亮点
- **智能环境验证：** 彩色输出的全面环境检查脚本
- **项目定制配置：** Node-RED专门配置，包含项目特定设置
- **定制节点框架：** 完整的hls-read和hls-write节点骨架
- **开发工作流：** 集成的npm脚本支持各种开发任务
- **文档完整性：** 详细的开发环境设置指南

### 配置要点
- Node-RED端口：1880
- 用户目录：./nodered-data
- 定制节点目录：src/nodes
- 日志配置：文件轮转，最大10MB
- 项目支持：已启用
- 调色板编辑：已启用

### Git提交记录
提交哈希: 3e75e95
提交信息: "feat: complete Node.js and Node-RED environment setup"

## QA结果
*此部分将在QA验证时填写*