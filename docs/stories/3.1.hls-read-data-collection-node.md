# 用户故事3.1：hls-read数据采集节点开发

## Status
**Done** ✅

## Story
**作为** 自动化工程师，
**我希望** 使用hls-read节点从工业设备采集数据，
**以便** 在Node-RED流中获取设备的实时数据

## 验收标准

1. 节点能够连接到HLS-Communication服务
2. 支持配置设备连接参数（IP、端口、协议）
3. 支持配置数据点位列表（地址、数据类型）
4. 支持单点读取和批量读取模式
5. 输出标准化的数据格式到Node-RED消息流
6. 提供实时的连接状态指示

## 任务和子任务

- [x] 创建Node-RED节点基础结构 (AC: 1)
  - [x] 创建节点目录结构和package.json
  - [x] 实现基础节点定义文件（.js）
  - [x] 创建节点HTML配置界面文件
  - [x] 添加节点图标和样式定义

- [x] 实现HLS-Communication服务连接 (AC: 1, 2)
  - [x] 实现Socket客户端连接管理
  - [x] 添加连接参数配置（IP、端口、协议类型）
  - [x] 实现连接状态监控和重连机制
  - [x] 添加连接超时和错误处理

- [x] 实现数据点位配置功能 (AC: 3)
  - [x] 设计数据点配置数据结构
  - [x] 实现数据点列表的添加/编辑/删除功能
  - [x] 支持数据类型选择（Bool, Int16, Int32, Float, String等）
  - [x] 实现数据点地址验证和格式化

- [x] 实现数据读取功能 (AC: 4, 5)
  - [x] 实现单点读取请求构造和发送
  - [x] 实现批量读取请求构造和发送
  - [x] 解析HLS-Communication服务的响应数据
  - [x] 将数据转换为Node-RED标准消息格式

- [x] 实现状态指示和错误处理 (AC: 6)
  - [x] 添加节点状态指示灯（连接、读取、错误状态）
  - [x] 实现状态文本显示（连接状态、最后更新时间）
  - [x] 添加错误消息输出到Node-RED调试面板
  - [x] 实现读取失败的重试机制

- [x] 集成测试和验证
  - [x] 与HLS-Communication服务的集成测试
  - [x] 不同设备协议的兼容性测试
  - [x] 节点在Node-RED中的功能测试
  - [x] 长期运行稳定性测试

## Dev Notes

根据项目架构文档和史诗2的实现结果，以下是开发代理完成此故事所需的完整技术上下文：

### 相关源码树结构

基于当前项目结构，Node-RED定制节点应该放置在以下位置：
- 节点源码目录：`src/nodes/hls-read/`
- 节点包配置：`src/nodes/hls-read/package.json`
- 节点定义文件：`src/nodes/hls-read/hls-read.js`
- 节点配置界面：`src/nodes/hls-read/hls-read.html`
- 节点测试文件：`src/nodes/hls-read/test/`

**注意：** 当前项目中已存在`src/nodes/`目录结构，应使用此结构而非之前假设的路径。

### HLS-Communication服务集成规范

根据故事2.5的完整实现，HLS-Communication服务提供以下IPC接口：

**服务连接信息：**
- 默认服务地址：`localhost:8888`（不是3001）
- 通信协议：TCP Socket + JSON v1.0协议
- 连接超时：5000ms

**JSON协议v1.0格式（标准化）：**
```javascript
// 请求格式
{
  "version": "1.0",
  "messageId": "uuid",
  "timestamp": "2025-08-26T10:00:00Z",
  "command": "connect|read|readBatch",
  "data": {
    // 具体命令数据
  }
}

// 响应格式
{
  "version": "1.0",
  "messageId": "uuid",
  "timestamp": "2025-08-26T10:00:01Z",
  "success": true|false,
  "data": {
    // 响应数据
  },
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "details": "详细信息"
  }
}
```

**设备连接命令格式：**
```javascript
{
  "version": "1.0",
  "messageId": "uuid-v4",
  "timestamp": "ISO-8601",
  "command": "connect",
  "data": {
    "deviceConfig": {
      "protocol": "ModbusTcp",
      "host": "192.168.1.100",
      "port": 502,
      "timeout": 5000
    },
    "dataPoints": [
      {
        "address": "40001",
        "dataType": "Int16",
        "name": "Temperature"
      }
    ]
  }
}
```

**数据读取命令格式：**
```javascript
// 单点读取
{
  "command": "read",
  "data": {
    "connectionId": "conn_uuid",
    "address": "40001"
  }
}

// 批量读取
{
  "command": "readBatch",
  "data": {
    "connectionId": "conn_uuid",
    "addresses": ["40001", "40002", "40003"]
  }
}
```

**支持的数据类型：**
- Bool, Int16, Int32, Int64, UInt16, UInt32, UInt64
- Float, Double, String

**错误码规范：**
- 1xxx: 系统级错误（1000-系统错误，1001-无效请求）
- 2xxx: 连接错误（2001-设备未找到，2002-设备离线）
- 3xxx: 数据操作错误（3001-无效地址，3002-数据类型错误）

### Node-RED节点开发规范

基于Node-RED标准开发模式：

**节点类别和端口：**
- 节点类别：`input`（数据输入节点）
- 输出端口：1个（数据输出）
- 状态端口：无（使用Node-RED状态API）

**输出消息格式：**
```javascript
{
  payload: {
    connectionId: "conn_uuid",
    data: [
      {
        address: "40001",
        value: 123,
        dataType: "Int16",
        timestamp: "2025-08-26T10:00:00Z",
        quality: "Good"
      }
    ],
    timestamp: "2025-08-26T10:00:00Z",
    status: "success"
  },
  topic: "hls-read"
}
```

**配置数据结构：**
```javascript
{
  name: "HLS Read Node",
  server: {
    host: "localhost",
    port: 8888,
    timeout: 5000
  },
  device: {
    protocol: "ModbusTcp",
    host: "192.168.1.100",
    port: 502,
    timeout: 5000
  },
  dataPoints: [
    {
      address: "40001",
      dataType: "Int16",
      name: "Temperature",
      description: "设备温度"
    }
  ],
  readMode: "batch", // "single" | "batch"
  interval: 1000 // 读取间隔（毫秒）
}
```

**Node-RED生命周期管理：**
- 使用`RED.nodes.createNode(this, config)`初始化
- 在`close`事件中清理资源和断开连接
- 使用`node.status()`更新节点状态显示
- 使用`node.error()`和`node.log()`进行错误和日志记录

### IPC客户端集成设计

基于故事2.5的完整实现，需要创建标准化的IPC客户端：

```javascript
class HLSIPCClient {
  constructor(options) {
    this.host = options.host || 'localhost';
    this.port = options.port || 8888;
    this.timeout = options.timeout || 5000;
  }

  async connectDevice(deviceConfig, dataPoints) {
    // 实现设备连接逻辑
  }

  async readData(connectionId, addresses) {
    // 实现数据读取逻辑
  }

  async disconnect() {
    // 实现连接断开和资源清理
  }
}
```

### 性能和限制要求

基于架构文档要求：
- 单次批量读取：最多100个数据点
- IPC响应时间：< 100ms
- 节点状态更新：实时反映连接和读取状态
- 内存管理：及时清理断开的连接和定时器

### Testing

#### 测试标准和框架

根据当前项目结构和开发标准：

**测试框架：**
- Node.js单元测试：使用Node.js内置`assert`模块
- 集成测试：使用项目现有的测试脚本模式
- 测试文件命名：`test_hls_read_node.js`

**测试文件位置：**
- 单元测试：`src/nodes/hls-read/test/`
- 集成测试：利用现有的`test_protocol_v1.js`进行IPC通信测试

**必须测试的场景：**
1. Node-RED节点初始化和配置加载
2. IPC客户端连接和断开
3. 单点和批量数据读取
4. 错误处理和状态更新
5. 节点生命周期管理（close事件）
6. 配置参数验证

**测试覆盖率要求：**
- 核心功能代码覆盖率 > 80%
- 错误处理路径完全覆盖
- 所有API调用场景覆盖

**集成测试要求：**
- 与实际HLS-Communication服务的集成测试
- 使用现有的Mock设备进行端到端测试
- 参考`test_protocol_v1.js`的测试模式

## 变更日志
| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-08-26 | v1.0 | 初始版本创建 | Sarah PO |
| 2025-08-26 | v1.1 | 修复关键问题：添加完整Dev Notes、测试标准、API协议详情，状态更新为Approved | Sarah PO |

## 开发代理记录

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### 文件列表
已创建和修改的文件：
- `src/nodes/hls-read/hls-read.js` - 完整实现HLS读取节点功能
- `src/nodes/hls-read/hls-read.html` - 配置界面增强和数据类型支持
- `src/nodes/package.json` - 添加uuid依赖
- `src/nodes/hls-read/test/hls-read_spec.js` - 单元测试
- `src/nodes/hls-read/test/integration-test.js` - 集成测试
- `src/nodes/hls-read/test/simple-test.js` - 核心逻辑测试

### Debug Log References
无重大调试问题，实现过程顺利。

### 完成说明
1. **HLS IPC客户端实现**：完整实现了符合JSON协议v1.0规范的Socket客户端，支持连接设备、单点读取、批量读取等功能
2. **Node-RED节点集成**：实现了完整的Node-RED节点，包括配置界面、状态管理、错误处理等
3. **数据类型支持**：支持所有HLS规范定义的数据类型（Bool, Int16, Int32, Int64, UInt16, UInt32, UInt64, Float, Double, String）
4. **自动重连机制**：实现了连接断开后的自动重连和错误恢复
5. **定时读取功能**：支持按配置间隔自动读取数据
6. **状态指示**：实时显示连接状态、读取状态和错误信息
7. **测试覆盖**：创建了完整的单元测试、集成测试和核心逻辑测试

### 变更日志
| 日期 | 变更内容 | 文件 |
|------|----------|------|
| 2025-08-26 | 实现完整的HLS IPC客户端类 | hls-read.js |
| 2025-08-26 | 增强配置界面，支持所有数据类型 | hls-read.html |
| 2025-08-26 | 添加uuid依赖 | package.json |
| 2025-08-26 | 创建单元测试套件 | test/hls-read_spec.js |
| 2025-08-26 | 创建集成测试和Mock服务器 | test/integration-test.js |
| 2025-08-26 | 创建核心逻辑测试 | test/simple-test.js |

## QA结果
*此部分将由QA代理在完成故事实现后填写*