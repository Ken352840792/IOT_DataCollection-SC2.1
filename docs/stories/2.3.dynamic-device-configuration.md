# 故事2.3：基础设备连接服务

## 状态
**Draft**

## 故事
**作为** Node-RED用户  
**我希望** HLS服务能够接收设备连接参数并建立连接  
**以便** 通过hls-read/write节点访问各种工业设备数据

## 验收标准

1. **设备连接参数接收**
   - 接收设备连接配置（IP地址、端口、协议类型）
   - 支持主流工业协议（Modbus TCP/RTU、Siemens、Omron等）
   - 验证连接参数的有效性和格式正确性
   - 提供连接参数的标准化数据结构

2. **基础连接管理**
   - 根据配置参数通过hlscommunication框架建立设备连接
   - 提供连接成功/失败的状态反馈
   - 支持连接的优雅断开和资源清理
   - 实现基本的连接错误处理和异常管理

3. **数据点位配置支持**
   - 接收数据点位配置（地址列表、数据类型）
   - 验证数据点位地址的有效性
   - 支持不同数据类型（bool、int、float、string）的配置
   - 提供数据点位配置的标准化格式

## 任务/子任务

- [ ] **连接参数处理** (AC: 1)
  - [ ] 设计设备连接配置的数据结构
  - [ ] 实现连接参数的验证逻辑（IP格式、端口范围等）
  - [ ] 添加协议类型的识别和路由
  - [ ] 实现参数格式标准化和错误提示
  - [ ] 创建连接配置的JSON Schema规范

- [ ] **设备连接建立** (AC: 2)
  - [ ] 实现基于hlscommunication的连接建立逻辑
  - [ ] 添加连接状态的反馈机制（成功/失败/超时）
  - [ ] 实现连接失败的详细错误处理和分类
  - [ ] 添加连接的优雅断开和资源释放
  - [ ] 实现基本的连接超时和异常管理

- [ ] **数据点位配置管理** (AC: 3)
  - [ ] 设计数据点位配置的数据结构
  - [ ] 实现点位地址的验证和格式检查
  - [ ] 添加数据类型的映射和转换逻辑
  - [ ] 提供点位配置的批量处理能力
  - [ ] 创建数据点位的标准化配置格式

## 开发注意事项

### 相关源码树信息
- 连接服务核心: `src/hls-service/connection/`
- 参数验证模块: `src/hls-service/validation/`
- hlscommunication集成: `src/hls-service/protocols/`
- IPC通信接口: `src/hls-service/ipc/`

### 技术要求
根据简化架构的核心需求：
- **参数接收：** 通过IPC接收Node-RED传来的设备连接参数
- **连接建立：** 基于hlscommunication框架建立设备连接
- **状态反馈：** 提供连接成功/失败的基本状态反馈
- **资源管理：** 确保连接的正确建立和清理

### IPC接口设计
```json
// 连接建立请求
{
  "action": "connect",
  "deviceConfig": {
    "protocol": "modbus-tcp",
    "host": "192.168.1.100",
    "port": 502,
    "timeout": 3000
  },
  "dataPoints": [
    {
      "address": "40001",
      "dataType": "int16",
      "name": "temperature"
    }
  ]
}

// 连接响应
{
  "status": "success|error",
  "connectionId": "conn_001",
  "message": "Connection established successfully",
  "error": null
}
```

### 设备连接配置数据模型
```json
{
  "protocol": "modbus-tcp|modbus-rtu|siemens-s7|omron-fins",
  "host": "192.168.1.100",
  "port": 502,
  "timeout": 3000,
  "deviceId": "optional-device-identifier"
}
```

### 数据点位配置数据模型  
```json
[
  {
    "address": "40001",
    "dataType": "int16|uint16|int32|uint32|float|bool|string",
    "name": "temperature",
    "description": "温度传感器"
  },
  {
    "address": "40002", 
    "dataType": "float",
    "name": "pressure",
    "description": "压力传感器"
  }
]
```

### 连接状态反馈
```json
{
  "connectionId": "conn_001",
  "status": "connected|disconnected|error",
  "timestamp": "2025-08-26T10:00:00Z",
  "error": {
    "code": "NETWORK_TIMEOUT|INVALID_ADDRESS|PROTOCOL_ERROR",
    "message": "具体错误描述"
  }
}
```

### 基础错误处理
- **参数验证错误：** IP格式、端口范围、协议类型验证
- **连接错误：** 网络超时、设备不可达、协议不匹配
- **数据点位错误：** 地址格式、数据类型不支持
- **资源错误：** 内存不足、连接数超限

### 测试

#### 测试标准
- IPC接口通信测试
- 设备连接参数验证测试
- hlscommunication框架集成测试
- 基本错误处理场景测试

#### 测试要求
- 验证连接参数的正确验证和格式化
- 测试各种设备协议的连接建立
- 验证连接状态反馈的准确性
- 测试资源清理和内存管理

#### 测试场景
- **正常连接：** 有效参数的设备连接建立
- **参数错误：** 无效IP、端口、协议的错误处理
- **网络异常：** 设备不可达、超时等情况
- **并发测试：** 多个设备同时连接的资源管理

## 变更日志

| 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|
| 2025-08-26 | 2.0 | 架构简化，重构为基础连接服务 | Sarah (PO) |
| 2025-08-25 | 1.0 | 初始故事创建 | Sarah (PO) |

## 开发代理记录
*此部分将在开发实施时由开发代理填写*

## QA结果
*此部分将在QA验证时填写*